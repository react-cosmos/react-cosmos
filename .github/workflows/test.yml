name: test
on: [push]
jobs:
  test-source-and-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'yarn'
      - run: yarn install --frozen-lockfile

      # Test source (with cross-package coverage)
      - run: yarn src
      - run: yarn check-types
      - run: yarn check-types:cypress
      - run: yarn lint
      - run: yarn test:coverage --maxWorkers=2
      - run: yarn codecov

      # Build packages
      - run: yarn dist
      - run: yarn build
      - uses: actions/upload-artifact@v3
        with:
          name: packages-dist
          path: packages/*/dist

  test-e2e:
    needs: test-source-and-build
    strategy:
      matrix:
        os:
          - ubuntu
          # - windows
        node-version: [16, 18]
        # TODO: example: [webpack, vite]
    runs-on: ${{ matrix.os }}-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'yarn'
      - run: yarn install --frozen-lockfile

      # Copy packages builds from previous job
      - uses: actions/download-artifact@v3
        with:
          name: packages-dist
          path: packages

      # Start web servers for each test type:
      # - DOM dev server
      # - DOM export
      # - Native dev server
      - run: yarn webpack:export
      - run: yarn example:webpack &
      - run: yarn example:webpack:serve &
      - run: yarn example:webpack:native &

      - run: yarn test:cypress
      - uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: cypress-screenshots-${{ matrix.os }}-node-${{ matrix.node-version }}
          path: cypress/screenshots
      - uses: actions/upload-artifact@v3
        with:
          name: cypress-videos-${{ matrix.os }}-node-${{ matrix.node-version }}
          path: cypress/videos
